{% extends "base.html" %}
{% load static %}

{% block title %}ADMIN User Management{% endblock %}

{% block content %}
{% include 'includes/topnav/topnav_admin.html' with page_title="ADMIN USER MANAGEMENT" %}
<div class="dashboard-container" style="padding: 15px; height: calc(100vh - 60px); overflow: auto;">
  <div style="background: #ffffff; padding: 20px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.15); height: 100%; display: flex; flex-direction: column;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
      <h2 style="margin: 0; color: #222; font-size: 20px;">User Management</h2>
      <a href="{% url 'account-create' %}"
         style="display: inline-block; padding: 10px 20px; background: #4CAF50; color: white; text-decoration: none; border-radius: 5px; font-weight: 500;">
        + Create New User
      </a>
    </div>

    <div style="flex: 1; overflow: auto;">
      <table style="width: 100%; border-collapse: collapse;">
        <thead>
          <tr style="background: #f2fdf8; border-bottom: 2px solid #ddd;">
            <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">User ID</th>
            <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Name</th>
            <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Role</th>
            <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Office</th>
            <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Status</th>
            <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for user in users %}
          <tr>
            <td style="padding: 10px; border: 1px solid #ddd;">{{ user.user_id }}</td>
            <td style="padding: 10px; border: 1px solid #ddd;">{{ user.first_name }} {{ user.last_name }}</td>
            <td style="padding: 10px; border: 1px solid #ddd;">{{ user.role }}</td>
            <td style="padding: 10px; border: 1px solid #ddd;">{{ user.office|default:"N/A" }}</td>
            <td style="padding: 10px; border: 1px solid #ddd;"><span style="color: #4CAF50; font-weight: 500;">Active</span></td>
            <td style="padding: 10px; border: 1px solid #ddd;">
              <button onclick="openEditModal('{{ user.user_id }}', '{{ user.first_name }} {{ user.last_name }}', '{{ user.role }}', '{{ user.office|default:"N/A" }}', '{{ user.username }}', '{{ user.email }}')" style="padding: 5px 10px; background: #2196F3; color: white; border: none; border-radius: 3px; cursor: pointer; margin-right: 5px;">Edit</button>
              <button onclick="openDeleteModal('{{ user.user_id }}', '{{ user.first_name }} {{ user.last_name }}')" style="padding: 5px 10px; background: #f44336; color: white; border: none; border-radius: 3px; cursor: pointer;">Delete</button>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="6" style="padding: 40px; text-align: center; color: #666; border: 1px solid #ddd;">
              No users found. Click "Create New User" to add users.
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Edit User Modal -->
<div id="editModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; z-index: 1000;">
  <div style="background: white; padding: 30px; border-radius: 10px; width: 500px;">
    <h3 style="margin: 0 0 20px 0; color: #222;">Edit User</h3>
    <form id="editForm" method="post" action="{% url 'admin-user-update' %}">
      {% csrf_token %}
      <input type="hidden" id="editUserId" name="user_id">
      <div style="margin-bottom: 15px;">
        <label style="display: block; margin-bottom: 5px; font-weight: 500;">First Name</label>
        <input type="text" id="editFirstName" name="first_name" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;" required>
      </div>
      <div style="margin-bottom: 15px;">
        <label style="display: block; margin-bottom: 5px; font-weight: 500;">Last Name</label>
        <input type="text" id="editLastName" name="last_name" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;" required>
      </div>
      <div style="margin-bottom: 15px;">
        <label style="display: block; margin-bottom: 5px; font-weight: 500;">Username</label>
        <input type="text" id="editUsername" name="username" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;" required>
      </div>
      <div style="margin-bottom: 15px;">
        <label style="display: block; margin-bottom: 5px; font-weight: 500;">Email</label>
        <input type="email" id="editEmail" name="email" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;" required>
      </div>
      <div style="margin-bottom: 15px;">
        <label style="display: block; margin-bottom: 5px; font-weight: 500;">Role</label>
        <select id="editRole" name="role" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;" required>
          <option value="Admin">Admin</option>
          <option value="Staff">Staff</option>
          <option value="PENRO">PENRO</option>
          <option value="CENRO">CENRO</option>
          <option value="Evaluator">Evaluator</option>
        </select>
      </div>
      <div style="display: flex; gap: 10px; justify-content: flex-end;">
        <button type="button" onclick="closeEditModal()" style="padding: 10px 20px; background: #ccc; color: #333; border: none; border-radius: 5px; cursor: pointer;">Cancel</button>
        <button type="submit" style="padding: 10px 20px; background: #2196F3; color: white; border: none; border-radius: 5px; cursor: pointer;">Save Changes</button>
      </div>
    </form>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; z-index: 1000;">
  <div style="background: white; padding: 30px; border-radius: 10px; width: 400px;">
    <h3 style="margin: 0 0 15px 0; color: #222;">Confirm Delete</h3>
    <p id="deleteMessage" style="margin-bottom: 20px; color: #666;"></p>
    <div style="display: flex; gap: 10px; justify-content: flex-end;">
      <button onclick="closeDeleteModal()" style="padding: 10px 20px; background: #ccc; color: #333; border: none; border-radius: 5px; cursor: pointer;">Cancel</button>
      <button onclick="confirmDelete()" style="padding: 10px 20px; background: #f44336; color: white; border: none; border-radius: 5px; cursor: pointer;">Delete</button>
    </div>
  </div>
</div>

<script>
let currentDeleteUserId = null;

function openEditModal(userId, name, role, office, username, email) {
  const nameParts = name.split(' ');
  document.getElementById('editUserId').value = userId;
  document.getElementById('editFirstName').value = nameParts[0] || '';
  document.getElementById('editLastName').value = nameParts.slice(1).join(' ') || '';
  document.getElementById('editUsername').value = username;
  document.getElementById('editEmail').value = email;
  document.getElementById('editRole').value = role;
  document.getElementById('editModal').style.display = 'flex';
}

function closeEditModal() {
  document.getElementById('editModal').style.display = 'none';
}

function openDeleteModal(userId, name) {
  currentDeleteUserId = userId;
  document.getElementById('deleteMessage').textContent = `Are you sure you want to delete user "${name}" (${userId})?`;
  document.getElementById('deleteModal').style.display = 'flex';
}

function closeDeleteModal() {
  document.getElementById('deleteModal').style.display = 'none';
  currentDeleteUserId = null;
}

function confirmDelete() {
  if (currentDeleteUserId) {
    // Create form and submit
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '{% url "admin-user-delete" %}';
    
    const csrfInput = document.createElement('input');
    csrfInput.type = 'hidden';
    csrfInput.name = 'csrfmiddlewaretoken';
    csrfInput.value = '{{ csrf_token }}';
    
    const userIdInput = document.createElement('input');
    userIdInput.type = 'hidden';
    userIdInput.name = 'user_id';
    userIdInput.value = currentDeleteUserId;
    
    form.appendChild(csrfInput);
    form.appendChild(userIdInput);
    document.body.appendChild(form);
    form.submit();
  }
}
</script>
{% endblock %}
